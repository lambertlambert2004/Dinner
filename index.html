<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>School Dinner Menu</title>
<link rel="apple-touch-icon" sizes="180x180" href="https://raw.githubusercontent.com/lambertlambert2004/Dinner/refs/heads/main/icon-180.PNG">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#1a202c">
<link rel="manifest" href="/manifest.json">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=SF+Pro+Display:wght@400;600;700&display=fallback" rel="stylesheet">
<style>
:root {
    --bg-light: linear-gradient(180deg, #fefce8, #f5f5f4);
    --bg-card-light: #ffffff;
    --text-light: #333333;
    --packed-light: linear-gradient(135deg, #fff5e0 0%, #fed7aa 100%);
    --accent-blue: #1d4ed8;
    --accent-green: #34c759;
    --accent-orange: #ff9500;
    --accent-red: #ff3b30;
    --shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    --border-radius: 16px;
    --font-family: -apple-system, 'SF Pro Display', 'Poppins', sans-serif;
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
body.dark-mode {
    --bg-light: #1a202c;
    --bg-card-light: #2d3748;
    --text-light: #e2e8f0;
    --packed-light: #4a422a;
    --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}
body {
    margin: 0;
    padding: 0 16px 100px;
    font-family: var(--font-family);
    background: var(--bg-light);
    color: var(--text-light);
    transition: var(--transition);
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
    background-image: radial-gradient(circle at 1px 1px, rgba(0,0,0,0.02) 1px, transparent 0);
    background-size: 20px 20px;
}
header {
    text-align: center;
    padding: 16px 0;
    background: var(--bg-light);
    position: sticky;
    top: 0;
    z-index: 20;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}
body:not(.dark-mode) header {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
}
h1 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
}
.sub-header {
    font-size: 0.9rem;
    color: #666666;
    margin: 4px 0;
}
body.dark-mode .sub-header {
    color: #a0aec0;
}
#weekInfo {
    font-size: 0.85rem;
    color: #666666;
}
body.dark-mode #weekInfo {
    color: #cbd5e0;
}
#menu {
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-width: 800px;
    margin: 16px auto 120px;
    transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
#menu.fade {
    opacity: 0;
}
.card {
    position: relative;
    border-radius: var(--border-radius);
    padding: 16px;
    background: var(--bg-card-light);
    box-shadow: var(--shadow);
    transition: var(--transition);
    cursor: pointer;
}
body:not(.dark-mode) .card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
}
.card:hover, .card:active {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
}
.card.packed {
    background: var(--packed-light);
    border: 2px solid #f59e0b;
    box-shadow: 0 0 0 1px rgba(245, 158, 11, 0.3);
    animation: pulse 2s infinite;
}
@keyframes pulse {
    0%, 100% { box-shadow: 0 0 0 1px rgba(245, 158, 11, 0.3); }
    50% { box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.1); }
}
.dayTitle {
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0 0 8px 0;
}
.menuText {
    white-space: pre-line;
    line-height: 1.5;
    font-size: 0.95rem;
    color: #444444;
}
body.dark-mode .menuText {
    color: #cbd5e0;
}
.allergens {
    margin-top: 8px;
    font-size: 0.8rem;
    color: #666666;
}
body.dark-mode .allergens {
    color: #a0aec0;
}
.dayLabel {
    position: absolute;
    top: 12px;
    right: 12px;
    padding: 4px 8px;
    font-weight: 600;
    font-size: 0.75rem;
    color: #fff;
    border-radius: 12px;
    z-index: 3;
}
.dayLabel.today { background: var(--accent-blue); animation: glowBlue 2.6s infinite alternate; }
.dayLabel.tomorrow { background: var(--accent-orange); animation: glowOrange 2.8s infinite alternate; }
.dayLabel.past { background: #8e8e93; }
@keyframes glowBlue {
    0% { box-shadow: 0 0 4px rgba(29, 78, 216, 0.5); }
    50% { box-shadow: 0 0 12px rgba(29, 78, 216, 0.8); }
    100% { box-shadow: 0 0 6px rgba(29, 78, 216, 0.6); }
}
@keyframes glowOrange {
    0% { box-shadow: 0 0 4px rgba(255, 149, 0, 0.5); }
    50% { box-shadow: 0 0 12px rgba(255, 149, 0, 0.8); }
    100% { box-shadow: 0 0 6px rgba(255, 149, 0, 0.6); }
}
.toggle-container {
    display: flex;
    flex-direction: column;
    gap: 8px;
    position: absolute;
    right: 12px;
    bottom: 12px;
}
.toggle {
    display: flex;
    align-items: center;
    gap: 8px;
}
.toggle input {
    opacity: 0;
    width: 0;
    height: 0;
}
.toggle .slider {
    position: relative;
    width: 51px;
    height: 31px;
    background-color: #d1d5db;
    border-radius: 15px;
    cursor: pointer;
    transition: background-color 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
body.dark-mode .toggle .slider {
    background-color: #4b5563;
}
.toggle .slider::before {
    content: '';
    position: absolute;
    left: 2px;
    top: 2px;
    width: 27px;
    height: 27px;
    background-color: #ffffff;
    border-radius: 50%;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
.toggle input:checked + .slider {
    background-color: var(--accent-green);
    box-shadow: 0 0 6px rgba(52, 199, 89, 0.4);
}
.toggle input:checked + .slider::before {
    transform: translateX(20px);
    box-shadow: 0 1px 4px rgba(52, 199, 89, 0.3);
}
.toggle:active .slider::before {
    transform: scale(0.95);
}
.toggle label {
    font-size: 0.85rem;
    color: #444444;
}
body.dark-mode .toggle label {
    color: #cbd5e0;
}
#weekNav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    max-width: 600px;
    margin: 16px auto;
    padding: 8px;
    background: var(--bg-card-light);
    border-radius: 14px;
    box-shadow: var(--shadow);
    position: sticky;
    top: 60px;
    z-index: 10;
}
body:not(.dark-mode) #weekNav {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
}
.progress-bar {
    height: 4px;
    background: #e5e7eb;
    border-radius: 2px;
    margin: 8px auto;
    max-width: 600px;
}
.progress-fill {
    height: 100%;
    background: var(--accent-blue);
    border-radius: 2px;
    transition: width 0.5s ease-in-out;
}
.nav-btn {
    padding: 8px 12px;
    border: none;
    border-radius: 12px;
    background: var(--accent-blue);
    color: #fff;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    min-width: 44px;
    min-height: 44px;
}
.nav-btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
.nav-btn:active:not(.disabled) {
    transform: scale(0.95);
}
.nav-btn svg {
    width: 20px;
    height: 20px;
    vertical-align: middle;
}
#weekTitle {
    font-weight: 600;
    font-size: 1rem;
}
#darkModeToggle, #manageChildrenBtn {
    position: fixed;
    right: 20px;
    width: 44px;
    height: 44px;
    background: var(--bg-card-light);
    border-radius: 50%;
    box-shadow: var(--shadow);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
}
#darkModeToggle {
    bottom: 20px;
}
#manageChildrenBtn {
    bottom: 76px;
}
#pullToRefresh {
    position: absolute;
    top: -50px;
    left: 50%;
    transform: translateX(-50%);
    text-align: center;
    font-size: 0.85rem;
    color: #666666;
    opacity: 0;
    transition: opacity 0.3s;
}
body.dark-mode #pullToRefresh {
    color: #a0aec0;
}
#pullToRefresh.visible {
    opacity: 1;
}
#modal, #confirmToggle, #manageChildrenModal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}
#modalContent, #confirmToggleContent, #manageChildrenContent {
    background: var(--bg-card-light);
    border-radius: var(--border-radius);
    padding: 20px;
    max-width: 90%;
    max-height: 80%;
    overflow-y: auto;
    box-shadow: var(--shadow);
    transform: scale(0.7);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
#modal.show #modalContent, #confirmToggle.show #confirmToggleContent, #manageChildrenModal.show #manageChildrenContent {
    transform: scale(1);
}
#modal h2, #confirmToggle h2, #manageChildrenModal h2 {
    margin: 0 0 12px;
    font-size: 1.2rem;
    font-weight: 600;
}
#modal p, #confirmToggle p, #manageChildrenModal p {
    margin: 0 0 12px;
    font-size: 0.95rem;
    color: #444444;
}
body.dark-mode #modal p, body.dark-mode #confirmToggle p, body.dark-mode #manageChildrenModal p {
    color: #cbd5e0;
}
#modal button, #confirmToggle button, #manageChildrenModal button {
    background: var(--accent-blue);
    color: #fff;
    border: none;
    padding: 10px 20px;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    margin: 0 5px;
}
#modal button:active, #confirmToggle button:active, #manageChildrenModal button:active {
    transform: scale(0.95);
}
#confirmToggle .button-group, #manageChildrenModal .button-group {
    display: flex;
    justify-content: space-between;
}
#childInput {
    padding: 8px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 0.95rem;
    margin-bottom: 12px;
    width: 100%;
    box-sizing: border-box;
}
body.dark-mode #childInput {
    border-color: #4b5563;
    background: #2d3748;
    color: #e2e8f0;
}
.children-list {
    margin-bottom: 12px;
}
.children-list div {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    font-size: 0.95rem;
}
.children-list button {
    background: var(--accent-red);
    padding: 6px 12px;
    font-size: 0.85rem;
}
:focus {
    outline: 2px solid var(--accent-blue);
    outline-offset: 2px;
}
</style>
</head>
<body class="dark-mode">
<div id="pullToRefresh">Pull to refresh...</div>
<header>
  <h1>School Dinner Menu</h1>
  <div class="sub-header" id="packedCount">Packed Meals This Week</div>
  <div id="weekInfo"></div>
</header>
<div id="weekNav">
    <button id="prevWeekBtn" class="nav-btn" aria-label="Previous Week">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6z"/></svg>
    </button>
    <button id="currentWeekBtn" class="nav-btn" aria-label="Current Week">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zm0 18a8 8 0 110-16 8 8 0 010 16zm1-13h-2v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
    </button>
    <div id="weekTitle"></div>
    <button id="nextWeekBtn" class="nav-btn" aria-label="Next Week">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6z"/></svg>
    </button>
</div>
<div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
<main id="menu"></main>
<div id="modal">
    <div id="modalContent">
        <h2 id="modalTitle"></h2>
        <p id="modalDescription"></p>
        <button id="modalClose">Close</button>
    </div>
</div>
<div id="confirmToggle">
    <div id="confirmToggleContent">
        <h2 id="confirmToggleTitle"></h2>
        <p id="confirmToggleMessage"></p>
        <div class="button-group">
            <button id="confirmToggleCancel">Cancel</button>
            <button id="confirmToggleConfirm">Confirm</button>
        </div>
    </div>
</div>
<div id="manageChildrenModal">
    <div id="manageChildrenContent">
        <h2>Manage Children</h2>
        <input type="text" id="childInput" placeholder="Enter child's name" />
        <div class="button-group">
            <button id="addChildBtn">Add Child</button>
            <button id="manageChildrenClose">Close</button>
        </div>
        <div class="children-list" id="childrenList"></div>
    </div>
</div>
<div id="manageChildrenBtn" aria-label="Manage Children">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
</div>
<div id="darkModeToggle" aria-label="Toggle Dark Mode">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.25a9.75 9.75 0 00-9.75 9.75 9.75 9.75 0 009.75 9.75c1.077 0 2.1-.194 3.05-.56a.75.75 0 00-.6-.69h0a.75.75 0 01-.85-.14 9.752 9.752 0 004.1-6.19c.12-.472-.345-.92-.85-.85a8.25 8.25 0 01-5.75 2.19c-3.15 0-5.727-2.585-5.727-5.757s2.577-5.757 5.727-5.757c1.838 0 3.52 1.054 4.58 2.687a.75.75 0 001.25-.664A9.752 9.752 0 0012 2.25z"/></svg>
</div>
<script>
const MENUS = {
    1: {
        Monday: "Oven baked sausages 🌭 / Vegetarian sausage\nAccompaniments of the day\nHomemade biscuit, peach slices / Fresh fruit",
        Tuesday: "BBQ chicken wrap 🌯 / Cheese and tomato pizza\nAccompaniments of the day\nFruit yoghurt pot / Fresh fruit",
        Wednesday: "Cheesy beany jacket 🥔 / Breaded chicken steak\nAccompaniments of the day\nPancake, sliced fruit / Fresh fruit",
        Thursday: "Cottage pie 🥧 / Tomato pasta bake\nAccompaniments of the day\nCocoa crispy bar / Fresh fruit",
        Friday: "Baked fish 🐟 / Cheese wrap\nAccompaniments of the day\nJam split, fruit wedge / Fresh fruit"
    },
    2: {
        Monday: "Breaded chicken steak 🍗 / Vegetable cheese bake\nAccompaniments of the day\nFruit yoghurt pot / Fresh fruit",
        Tuesday: "Pasta bolognese 🍝 / Omelette\nAccompaniments of the day\nJelly, mandarins / Fresh fruit",
        Wednesday: "Chicken curry 🍛 / Cheese and tomato pizza\nAccompaniments of the day\nFruit muffin / Fresh fruit",
        Thursday: "Roast chicken 🥚 / Pasta Napolitana\nAccompaniments of the day\nCookie / Fresh fruit",
        Friday: "Fish fingers 🐟 / Cheese wrap\nAccompaniments of the day\nWelsh cake, fruit wedge / Fresh fruit"
    },
    3: {
        Monday: "Meatballs 🍲 / Tomato pasta bake\nAccompaniments of the day\nJam split, fruit wedge / Fresh fruit",
        Tuesday: "Chicken curry 🍛 / Margherita pizza\nAccompaniments of the day\nFruit yoghurt pot / Fresh fruit",
        Wednesday: "Cheese and tomato calzone 🍕 / Breaded chicken steak\nAccompaniments of the day\nJelly, mandarins / Fresh fruit",
        Thursday: "Roast turkey 🦃 / Macaroni cheese\nAccompaniments of the day\nChocolate cookie / Fresh fruit",
        Friday: "Baked fish 🐟 / Cheese wrap\nAccompaniments of the day\nFruit muffin / Fresh fruit"
    }
};
const MENU_DETAILS = {
    1: {
        Monday: { description: "Oven baked sausages or vegetarian sausage with daily accompaniments. Includes homemade biscuit and peach slices or fresh fruit. Halal baked sausage or GF/DF sausage available." },
        Tuesday: { description: "BBQ chicken wrap or cheese and tomato pizza with daily accompaniments. Served with fruit yoghurt pot or fresh fruit. Halal or GF/DF BBQ chicken wrap available." },
        Wednesday: { description: "Cheesy beany jacket potato or breaded chicken steak with daily accompaniments. Includes pancake with sliced fruit or fresh fruit. Halal breaded chicken steak or GF/DF cheesy beany jacket available." },
        Thursday: { description: "Traditional cottage pie or tomato pasta bake with daily accompaniments. Comes with cocoa crispy bar or fresh fruit. Halal cottage pie or GF/DF tomato pasta bake available." },
        Friday: { description: "Baked fish or cheese wrap with daily accompaniments. Includes jam split and fruit wedge or fresh fruit. Halal baked fish, GF/DF fish fingers, or baked salmon option available." }
    },
    2: {
        Monday: { description: "Breaded chicken steak or vegetable cheese bake with daily accompaniments. Includes fruit yoghurt pot or fresh fruit. Halal or GF/DF chicken steak available." },
        Tuesday: { description: "Pasta bolognese or omelette with daily accompaniments. Served with jelly and mandarins or fresh fruit. Halal or GF/DF pasta bolognese available." },
        Wednesday: { description: "Mild chicken curry or cheese and tomato pizza with daily accompaniments. Includes fruit muffin or fresh fruit. Halal or GF/DF chicken curry available." },
        Thursday: { description: "Roast chicken or pasta Napolitana with daily accompaniments. Comes with a cookie or fresh fruit. Halal or GF/DF roast chicken available." },
        Friday: { description: "Fish fingers or cheese wrap with daily accompaniments. Includes Welsh cake and fruit wedge or fresh fruit. Halal or GF/DF fish fingers or baked salmon option available." }
    },
    3: {
        Monday: { description: "Meatballs or tomato pasta bake with daily accompaniments. Includes jam split and fruit wedge or fresh fruit. Halal or GF/DF meatballs available." },
        Tuesday: { description: "Mild chicken curry or margherita pizza with daily accompaniments. Served with fruit yoghurt pot or fresh fruit. Halal or GF/DF chicken curry available." },
        Wednesday: { description: "Cheese and tomato calzone or breaded chicken steak with daily accompaniments. Includes jelly and mandarins or fresh fruit. Halal breaded chicken steak available." },
        Thursday: { description: "Roast turkey or macaroni cheese with daily accompaniments. Comes with chocolate cookie or fresh fruit. Halal or GF/DF roast turkey available." },
        Friday: { description: "Baked fish or cheese wrap with daily accompaniments. Includes fruit muffin or fresh fruit. Halal baked fish, GF/DF fish fingers, or baked salmon option available." }
    }
};
const ALLERGENS = {
    1: {
        Monday: ["gluten", "dairy"],
        Tuesday: ["gluten", "dairy"],
        Wednesday: ["gluten", "dairy"],
        Thursday: ["gluten", "dairy"],
        Friday: ["fish", "gluten", "dairy"]
    },
    2: {
        Monday: ["gluten", "dairy"],
        Tuesday: ["gluten", "dairy"],
        Wednesday: ["gluten", "dairy"],
        Thursday: ["gluten"],
        Friday: ["fish", "gluten", "dairy"]
    },
    3: {
        Monday: ["gluten"],
        Tuesday: ["gluten", "dairy"],
        Wednesday: ["gluten", "dairy"],
        Thursday: ["gluten", "dairy"],
        Friday: ["fish", "gluten", "dairy"]
    }
};
const ALLERGEN_ICONS = { gluten: "🌾", dairy: "🧀", fish: "🐟", nuts: "🥜" };
const weekMap = [
    { week: 1, start: "2025-09-01" }, { week: 2, start: "2025-09-08" }, { week: 3, start: "2025-09-15" },
    { week: 1, start: "2025-09-22" }, { week: 2, start: "2025-09-29" }, { week: 3, start: "2025-10-06" },
    { week: 1, start: "2025-10-13" }, { week: 2, start: "2025-10-20" }, { week: 3, start: "2025-11-03" },
    { week: 1, start: "2025-11-10" }, { week: 2, start: "2025-11-17" }, { week: 3, start: "2025-11-24" },
    { week: 1, start: "2025-12-01" }, { week: 2, start: "2025-12-08" }, { week: 3, start: "2025-12-15" }
];
let packedLunch = JSON.parse(localStorage.getItem('packedLunch') || '{}');
let children = JSON.parse(localStorage.getItem('children') || '[]');
let currentWeekIndex = 0;
const menuContainer = document.getElementById('menu');
const weekTitleEl = document.getElementById('weekTitle');
const packedCountEl = document.getElementById('packedCount');
const prevWeekBtn = document.getElementById('prevWeekBtn');
const nextWeekBtn = document.getElementById('nextWeekBtn');
const currentWeekBtn = document.getElementById('currentWeekBtn');
const darkModeToggle = document.getElementById('darkModeToggle');
const manageChildrenBtn = document.getElementById('manageChildrenBtn');
const pullToRefresh = document.getElementById('pullToRefresh');
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modalTitle');
const modalDescription = document.getElementById('modalDescription');
const modalClose = document.getElementById('modalClose');
const confirmToggle = document.getElementById('confirmToggle');
const confirmToggleTitle = document.getElementById('confirmToggleTitle');
const confirmToggleMessage = document.getElementById('confirmToggleMessage');
const confirmToggleCancel = document.getElementById('confirmToggleCancel');
const confirmToggleConfirm = document.getElementById('confirmToggleConfirm');
const manageChildrenModal = document.getElementById('manageChildrenModal');
const manageChildrenClose = document.getElementById('manageChildrenClose');
const addChildBtn = document.getElementById('addChildBtn');
const childInput = document.getElementById('childInput');
const childrenList = document.getElementById('childrenList');
const progressFill = document.getElementById('progressFill');
if (localStorage.getItem('darkMode') !== 'false') document.body.classList.add('dark-mode');
if (children.length === 0) children = ['Child 1'];
function getInitialWeekIndex() {
    try {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayTimestamp = today.getTime();
        const isSunday = today.getDay() === 0;
        if (!weekMap || !Array.isArray(weekMap) || weekMap.length === 0) return 0;
        for (let i = weekMap.length - 1; i >= 0; i--) {
            const weekStart = new Date(weekMap[i].start);
            if (isNaN(weekStart.getTime())) continue;
            weekStart.setHours(0, 0, 0, 0);
            if (todayTimestamp >= weekStart.getTime()) {
                return isSunday && i < weekMap.length - 1 ? i + 1 : i;
            }
        }
        return 0;
    } catch (e) {
        return 0;
    }
}
function renderMenu() {
    try {
        if (!menuContainer) throw new Error('Menu container missing');
        menuContainer.classList.add('fade');
        setTimeout(() => {
            menuContainer.innerHTML = '';
            renderMenuContent(menuContainer);
            menuContainer.classList.remove('fade');
            updateNavButtons();
            redrawCurrentWeekBtn(); // Ensure SVG persists
        }, 300);
    } catch (e) {
        if (menuContainer) menuContainer.innerHTML = '<div class="card"><div class="dayTitle">Error</div><div class="menuText">Failed to load menu.</div></div>';
        menuContainer.classList.remove('fade');
    }
}
function redrawCurrentWeekBtn() {
    currentWeekBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zm0 18a8 8 0 110-16 8 8 0 010 16zm1-13h-2v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>`;
}
function renderMenuContent(container) {
    try {
        const weekInfo = weekMap[currentWeekIndex];
        if (!weekInfo || !MENUS[weekInfo.week]) {
            currentWeekIndex = 0;
            renderMenuContent(container);
            return;
        }
        container.innerHTML = '';
        const weekdays = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const weekStartDate = new Date(weekInfo.start);
        if (isNaN(weekStartDate.getTime())) {
            container.innerHTML = '<div class="card"><div class="dayTitle">Error</div><div class="menuText">Invalid date.</div></div>';
            return;
        }
        weekStartDate.setHours(0, 0, 0, 0);
        weekTitleEl.textContent = `Week ${weekInfo.week}`;
        document.getElementById('weekInfo').textContent = `Week commencing ${weekStartDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })}`;
        progressFill.style.width = `${((currentWeekIndex + 1) / weekMap.length) * 100}%`;
        weekdays.forEach((day, index) => {
            const card = document.createElement("div");
            card.classList.add("card");
            const dayDate = new Date(weekStartDate);
            dayDate.setDate(weekStartDate.getDate() + index);
            dayDate.setHours(0, 0, 0, 0);
            const label = document.createElement("span");
            if (dayDate.getTime() === today.getTime()) {
                label.textContent = "Today ☀️";
                label.className = "dayLabel today";
                card.appendChild(label);
            } else if (dayDate.getTime() === today.getTime() + 86400000) {
                label.textContent = "Tomorrow 🌅";
                label.className = "dayLabel tomorrow";
                card.appendChild(label);
            } else if (dayDate.getTime() < today.getTime()) {
                label.textContent = "Past";
                label.className = "dayLabel past";
                card.appendChild(label);
            }
            const title = document.createElement("div");
            title.className = "dayTitle";
            title.textContent = day;
            card.appendChild(title);
            const menuText = document.createElement("div");
            menuText.className = "menuText";
            menuText.textContent = MENUS[weekInfo.week][day] || "Menu not available";
            card.appendChild(menuText);
            const allergens = document.createElement("div");
            allergens.className = "allergens";
            allergens.textContent = "Allergens: " + (ALLERGENS[weekInfo.week][day]?.map(a => ALLERGEN_ICONS[a]).join(" ") || "None");
            card.appendChild(allergens);
            const toggleContainer = document.createElement("div");
            toggleContainer.className = "toggle-container";
            children.forEach(child => {
                const toggle = document.createElement("label");
                toggle.className = "toggle";
                const input = document.createElement("input");
                input.type = "checkbox";
                input.checked = !!packedLunch[child]?.[weekInfo.week]?.[day];
                const slider = document.createElement("span");
                slider.className = "slider";
                const childLabel = document.createElement("label");
                childLabel.textContent = child;
                toggle.appendChild(input);
                toggle.appendChild(slider);
                toggle.appendChild(childLabel);
                toggleContainer.appendChild(toggle);
                input.addEventListener("change", (e) => {
                    e.preventDefault();
                    confirmToggleTitle.textContent = input.checked ? `Add Packed Lunch for ${child}` : `Remove Packed Lunch for ${child}`;
                    confirmToggleMessage.textContent = input.checked ? `Add packed lunch for ${child} on ${day}?` : `Remove packed lunch for ${child} on ${day}?`;
                    confirmToggle.style.display = "flex";
                    setTimeout(() => confirmToggle.classList.add("show"), 10);
                    confirmToggleConfirm.onclick = () => {
                        if (!packedLunch[child]) packedLunch[child] = {};
                        if (!packedLunch[child][weekInfo.week]) packedLunch[child][weekInfo.week] = {};
                        if (input.checked) packedLunch[child][weekInfo.week][day] = true;
                        else delete packedLunch[child][weekInfo.week][day];
                        localStorage.setItem('packedLunch', JSON.stringify(packedLunch));
                        updatePackedCount();
                        card.classList.toggle("packed", Object.keys(packedLunch).some(c => packedLunch[c][weekInfo.week]?.[day]));
                        confirmToggle.classList.remove("show");
                        setTimeout(() => confirmToggle.style.display = "none", 300);
                    };
                    confirmToggleCancel.onclick = () => {
                        input.checked = !input.checked;
                        confirmToggle.classList.remove("show");
                        setTimeout(() => confirmToggle.style.display = "none", 300);
                    };
                });
            });
            card.appendChild(toggleContainer);
            card.addEventListener("click", (e) => {
                if (e.target.closest(".toggle")) return;
                modalTitle.textContent = `${day} - Week ${weekInfo.week}`;
                modalDescription.textContent = `${MENU_DETAILS[weekInfo.week][day]?.description || "No description available"}\n\nAllergens: ${ALLERGENS[weekInfo.week][day]?.map(a => ALLERGEN_ICONS[a]).join(" ") || "None"}`;
                modal.style.display = "flex";
                setTimeout(() => modal.classList.add("show"), 10);
            });
            container.appendChild(card);
        });
        updatePackedCount();
    } catch (e) {
        container.innerHTML = '<div class="card"><div class="dayTitle">Error</div><div class="menuText">Failed to load content.</div></div>';
    }
}
function updatePackedCount() {
    try {
        const weekInfo = weekMap[currentWeekIndex];
        if (!weekInfo) {
            packedCountEl.textContent = "Packed Meals This Week";
            return;
        }
        let text = "Packed Meals This Week";
        if (children.length === 1) {
            const count = Object.keys(packedLunch[children[0]]?.[weekInfo.week] || {}).length;
            text = `Packed Meals This Week: ${count}`;
        } else {
            text = "Packed Meals This Week:\n";
            children.forEach(child => {
                const count = Object.keys(packedLunch[child]?.[weekInfo.week] || {}).length;
                text += `${child}: ${count}\n`;
            });
        }
        packedCountEl.textContent = text;
    } catch (e) {
        packedCountEl.textContent = "Packed Meals This Week";
    }
}
function updateNavButtons() {
    try {
        prevWeekBtn.classList.toggle("disabled", currentWeekIndex === 0);
        nextWeekBtn.classList.toggle("disabled", currentWeekIndex === weekMap.length - 1);
    } catch (e) {}
}
function renderChildrenList() {
    childrenList.innerHTML = '';
    children.forEach(child => {
        const div = document.createElement('div');
        div.textContent = child;
        const removeBtn = document.createElement('button');
        removeBtn.textContent = 'Remove';
        removeBtn.onclick = () => {
            confirmToggleTitle.textContent = `Remove ${child}`;
            confirmToggleMessage.textContent = `Are you sure you want to remove ${child}?`;
            confirmToggle.style.display = "flex";
            setTimeout(() => confirmToggle.classList.add("show"), 10);
            confirmToggleConfirm.onclick = () => {
                children = children.filter(c => c !== child);
                delete packedLunch[child];
                localStorage.setItem('children', JSON.stringify(children));
                localStorage.setItem('packedLunch', JSON.stringify(packedLunch));
                if (children.length === 0) children = ['Child 1'];
                renderChildrenList();
                renderMenu();
                confirmToggle.classList.remove("show");
                setTimeout(() => confirmToggle.style.display = "none", 300);
            };
            confirmToggleCancel.onclick = () => {
                confirmToggle.classList.remove("show");
                setTimeout(() => confirmToggle.style.display = "none", 300);
            };
        };
        div.appendChild(removeBtn);
        childrenList.appendChild(div);
    });
}
let startY = 0;
let isPulling = false;
document.addEventListener('touchstart', (e) => {
    if (window.scrollY === 0) {
        startY = e.touches[0].clientY;
        isPulling = true;
    }
});
document.addEventListener('touchmove', (e) => {
    if (isPulling) {
        const currentY = e.touches[0].clientY;
        pullToRefresh.classList.toggle('visible', currentY - startY > 50);
    }
});
document.addEventListener('touchend', () => {
    if (isPulling && pullToRefresh.classList.contains('visible')) {
        renderMenu();
        pullToRefresh.classList.remove('visible');
    }
    isPulling = false;
});
prevWeekBtn.addEventListener('click', () => {
    if (currentWeekIndex > 0) {
        currentWeekIndex--;
        renderMenu();
    }
});
nextWeekBtn.addEventListener('click', () => {
    if (currentWeekIndex < weekMap.length - 1) {
        currentWeekIndex++;
        renderMenu();
    }
});
currentWeekBtn.addEventListener('click', () => {
    const initialIndex = getInitialWeekIndex();
    if (currentWeekIndex !== initialIndex) {
        currentWeekIndex = initialIndex;
        renderMenu();
    }
});
darkModeToggle.addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
});
modalClose.addEventListener('click', () => {
    modal.classList.remove('show');
    setTimeout(() => modal.style.display = "none", 300);
});
manageChildrenBtn.addEventListener('click', () => {
    manageChildrenModal.style.display = "flex";
    setTimeout(() => manageChildrenModal.classList.add("show"), 10);
    renderChildrenList();
});
manageChildrenClose.addEventListener('click', () => {
    manageChildrenModal.classList.remove("show");
    setTimeout(() => manageChildrenModal.style.display = "none", 300);
});
addChildBtn.addEventListener('click', () => {
    const name = childInput.value.trim();
    if (name && !children.includes(name)) {
        children.push(name);
        localStorage.setItem('children', JSON.stringify(children));
        childInput.value = '';
        renderChildrenList();
        renderMenu();
    }
});
function requestNotificationPermission() {
    try {
        if ("Notification" in window && Notification.permission !== "denied") {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") console.log("Notifications enabled");
            });
        }
    } catch (e) {}
}
document.addEventListener('DOMContentLoaded', () => {
    try {
        localStorage.setItem('children', JSON.stringify(children));
        currentWeekIndex = getInitialWeekIndex();
        requestNotificationPermission();
        renderMenu();
        requestAnimationFrame(() => {
            currentWeekBtn.style.opacity = '0';
            requestAnimationFrame(() => {
                currentWeekBtn.style.opacity = '1';
                redrawCurrentWeekBtn();
            });
        });
    } catch (e) {
        if (menuContainer) menuContainer.innerHTML = '<div class="card"><div class="dayTitle">Error</div><div class="menuText">Failed to load menu.</div></div>';
    }
});
document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
        redrawCurrentWeekBtn();
    }
});
</script>
</body>
</html>
